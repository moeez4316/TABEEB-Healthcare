# TABEEB Healthcare — Pre-built images for Oracle Cloud deployment
# No building required on the VM — just pull and run!
#
# Usage:
#   docker compose -f docker-compose.prebuilt.yml pull
#   docker compose -f docker-compose.prebuilt.yml up -d

services:
  backend:
    image: hammadhafeez1100/tabeeb-backend:latest
    container_name: tabeeb_backend
    restart: unless-stopped
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=${PORT:-5002}
      - DATABASE_URL=${DATABASE_URL}
      - MONGO_URI=${MONGO_URI}
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - ADMIN_JWT_SECRET=${ADMIN_JWT_SECRET}
      - ADMIN_USERNAME=${ADMIN_USERNAME}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - ADMIN_CREDENTIALS=${ADMIN_CREDENTIALS}
      - RATE_LIMIT_ENABLED=${RATE_LIMIT_ENABLED:-true}
      - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}
      - FIREBASE_PRIVATE_KEY=${FIREBASE_PRIVATE_KEY}
      - FIREBASE_CLIENT_EMAIL=${FIREBASE_CLIENT_EMAIL}
      - CLOUDINARY_CLOUD_NAME=${CLOUDINARY_CLOUD_NAME}
      - CLOUDINARY_API_KEY=${CLOUDINARY_API_KEY}
      - CLOUDINARY_API_SECRET=${CLOUDINARY_API_SECRET}
      - JITSI_APP_ID=${JITSI_APP_ID}
      - JITSI_APP_SECRET=${JITSI_APP_SECRET}
      - JITSI_DOMAIN=${JITSI_DOMAIN}
      - RESEND_API_KEY=${RESEND_API_KEY}
      - RESEND_FROM_EMAIL=${RESEND_FROM_EMAIL}
      - RESEND_REPLY_TO=${RESEND_REPLY_TO}
      - RESEND_DOMAIN=${RESEND_DOMAIN}
      - RESEND_WEBHOOK_SECRET=${RESEND_WEBHOOK_SECRET}
    ports:
      - "5002:5002"
    networks:
      - tabeeb_network
    deploy:
      resources:
        limits:
          cpus: '0.8'
          memory: 768M
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5002/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  frontend:
    image: hammadhafeez1100/tabeeb-frontend:latest
    container_name: tabeeb_frontend
    restart: unless-stopped
    depends_on:
      - backend
    environment:
      - NODE_ENV=${NODE_ENV:-production}
    ports:
      - "3000:3000"
    networks:
      - tabeeb_network
    deploy:
      resources:
        limits:
          cpus: '0.8'
          memory: 768M
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  caddy:
    image: caddy:2-alpine
    container_name: tabeeb_caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - tabeeb_network
    depends_on:
      - backend
      - frontend
    deploy:
      resources:
        limits:
          cpus: '0.4'
          memory: 192M

networks:
  tabeeb_network:
    driver: bridge

volumes:
  caddy_data:
    driver: local
  caddy_config:
    driver: local
